# Hero Skill Data Processor - Specification Document (v4.0)

## 1. プロジェクト概要

### 1.1. 目的
複数のデータソースを統合・解析し、Astro.js製の新しいHeroデータベースのための、信頼できる構造化データソースを生成する。
このプロジェクトの最終目標は、「100%の完全自動化」という非現実的な理想を追うことではない。
**「8割の標準的なスキルをAIが自動で解析し、残りの2割の複雑な例外は、人間が、専用の補助ツール（CSVルール）を使って、効率的に修正・管理できる、持続可能なデータパイプラインを構築する」**こと、それこそが、私たちの目的である。

### 1.2. 最終成果物
-   **`hero_skill_output.csv` (最終成果物)**: 人間が閲覧するための、整形済みテキスト。`passive_en/ja` と `ss_en/ja` の列に分割されている。
-   **`hero_skill_output_debug.csv` (デバッグ 兼 上書きルール作成元)**: テキスト情報を除外した、構造と数値の情報に特化した、軽量なCSV。
-   **`debug_hero_data.json` (解析の一次ソース)**: 全てのデータソースを統合した「真実の源」。解析プロセスは、必ず、一度ディスクに書き出された、このファイルを読み込むことから始める。
-   **`health_report.csv` (健康診断レポート)**: `bbcamp.info` のAPIデータと、スクリプトの解析結果の差分をまとめた、客観的な品質レポート。

## 2. ファイル構成
-   **`hero_main.py`**: 司令塔。処理フローの制御と、最終的なファイルの出力。
-   **`hero_data_loader.py`**: データ入力担当。
-   **`hero_parser.py`**: データ解析ロジックの本体。
-   **`hero_health_checker.py`**: API連携による、自動健康診断ツール。

## 3. データソース

### 3.1. 入力データ
-   各種ゲームデータJSON, CSV。
-   `pass.csv`: パッシブスキルの正解 `lang_id` の一部。
-   `slug.csv`: ゲーム内IDと `bbcamp.info` のURLスラッグのマッピング。

### 3.2. 手動設定ファイル (人間による制御)
-   **`exception_lang_rules.csv`**: `lang_id` の自動推測が失敗する**例外的なケース**を、手動で上書きするためのルールブック。
-   **`exception_hero_rules.csv`**: パラメータ解決が失敗する**例外的なケース**を、手動で上書きするためのルールブック。
-   **`hero_skill_input.csv` (将来実装)**: `debug.csv` と同じフォーマットを持つ、究極の上書きルールファイル。スクリプトの解析結果を、セル単位でピンポイントに上書きし、AIの推測よりも優先される、**人間による最終的な「正解データ」**として機能する。

## 4. データ処理アーキテクチャ

### 4.1. 第一段階：データ統合
-   `get_full_hero_data` が、ID連鎖を解決し、完全な `full_hero_data` を構築。
-   その結果を、**中間成果物 `debug_hero_data.json` として、必ずディスクに書き出す。**

### 4.2. 第二段階：スキル解析
-   **`debug_hero_data.json` を、ファイルから改めて読み込み直す。**
-   以降の全てのスキル解析は、この読み込んだデータだけをインプットとして実行する。

## 5. スキル解析ロジック (`hero_parser.py`)

### 5.1. `lang_id` の決定 (`find_best_lang_id`)
-   **目的**: スキルブロックの内容から、最もふさわしい `lang_id` を**自動推測**する。この自動推測は、**8割程度の、標準的なスキル**を正しく処理することを目標とする。
-   **手法**: 「再帰的キーワード収集」と「深さによる加重スコアリング」を組み合わせ、スキルブロックの表面だけでなく、その中身や親の文脈まで考慮して、最も可能性の高い `lang_id` を選択する。

### 5.2. パッシブスキル (`parse_passive_skills`)
-   **対象**: `passiveSkills` と `costumePassives` の両方。
-   **`lang_id` 決定**: タイトルと説明文で、検索範囲を厳密に分離する。「直接構築」を試み、失敗した場合にのみ、「自動推測 (`find_best_lang_id`)」に切り替える。
-   **表示順**: `_format_final_description` で出力する際、データ配列の**逆順**で処理される。

### 5.3. コンテナ型スキル (`parse_properties`)
-   **定義**: `manaSpeedId` (`charge_ninja`など) に紐づく、`ChargedSpecial` や `RotatingSpecial` といった、複数の独立したスキルを内包するプロパティ。
-   **解析フロー**: 専用の解析モードで、コンテナ自身の導入文と、中身の各スキルを、パーサー群を再帰的に呼び出して、完全に解析する。

### 5.4. 未解決の課題（`exception` または将来のロジック改善で対応）
-   `RandomProperties` (Danzaburo) や `BranchingSpecial` (Emilio) のような、極めて複雑なロジックを持つコンテナ型スキル。
-   `SideDependentPassiveSkill` (Troop Mastery) のような、複数の `lang_id` を組み合わせる必要がある、超例外的なパッシブスキル。

## 6. 品質保証と開発サイクル

このプロジェクトの開発は、「自動化」と「人間の知性」を組み合わせた、以下のサイクルで進める。

1.  **診断 (`hero_health_checker.py`)**:
    *   API経由で `bbcamp.info` の最新データを取得し、スクリプトの解析結果と比較。`health_report.csv` を生成する。

2.  **分析**:
    *   `health_report.csv` をレビューし、不一致の**原因を分析**する。

3.  **判断**:
    *   その原因が、
        a. 多くのヒーローに共通する、**修正すべき「バグ」**なのか、
        b. 少数のヒーローに限定される、**対応すべき「例外」**なのか、
    *   を、**私たち二人が、一緒に見極める**。

4.  **対処**:
    *   もし「バグ」であれば、パーサーの**コアロジックを修正**する。
    *   もし「例外」であれば、**`exception_..._rules.csv` にルールを追加**して対応する。

5.  **回帰**:
    *   再びステップ1に戻り、`health_report.csv` から問題が消えていることを確認する。

このサイクルを繰り返すことで、私たちは、エンジンの基本性能を高めつつ、人間の知性でAIの限界を補う、最も効率的で、最も確実な方法で、ツールを100%の完成度へと近づけていく。